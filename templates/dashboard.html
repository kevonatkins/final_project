{% extends "layout.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto">

  <div class="flex items-center justify-between mb-6">
    <h1 class="text-2xl font-bold text-gray-800">Dashboard</h1>

    <div class="flex gap-2">
      <a href="/dashboard/profile"
         class="px-3 py-2 rounded bg-gray-900 text-white hover:bg-gray-800">
        Profile / Settings
      </a>
      <button id="logoutBtn"
              class="px-3 py-2 rounded border border-gray-300 hover:bg-gray-50">
        Logout
      </button>
    </div>
  </div>

  <div id="msg" class="hidden px-4 py-3 rounded border mb-4"></div>

  <div class="bg-white border border-gray-200 rounded-lg p-5 mb-6">
    <h2 class="text-lg font-semibold text-gray-800 mb-3">New Calculation</h2>

    <form id="calculationForm" class="flex flex-col md:flex-row gap-3">
      <select id="calcType" class="border rounded px-3 py-2 w-full md:w-48">
        <option value="addition">Addition</option>
        <option value="subtraction">Subtraction</option>
        <option value="multiplication">Multiplication</option>
        <option value="division">Division</option>
      </select>

      <input id="calcInputs"
             type="text"
             placeholder="Numbers (comma-separated) e.g. 5, 10, 15"
             class="border rounded px-3 py-2 w-full" />

      <button type="submit"
              class="px-4 py-2 rounded bg-blue-700 text-white hover:bg-blue-800">
        Calculate
      </button>
    </form>
  </div>

  <div class="bg-white border border-gray-200 rounded-lg p-5">
    <h2 class="text-lg font-semibold text-gray-800 mb-3">Calculation History</h2>

    <div class="overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead class="bg-gray-50">
          <tr>
            <th class="text-left px-3 py-2 border-b">Type</th>
            <th class="text-left px-3 py-2 border-b">Inputs</th>
            <th class="text-left px-3 py-2 border-b">Result</th>
            <th class="text-left px-3 py-2 border-b">Date</th>
            <th class="text-left px-3 py-2 border-b">Actions</th>
          </tr>
        </thead>
        <tbody id="calculationsTable">
          <tr>
            <td colspan="5" class="px-3 py-4 text-gray-500">Loading...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const token = localStorage.getItem('access_token');
  if (!token) {
    window.location.href = '/login';
    return;
  }

  const msg = document.getElementById('msg');
  function showMsg(text, kind) {
    msg.textContent = text;
    msg.classList.remove('hidden');
    msg.classList.remove('border-red-300', 'bg-red-50', 'text-red-800');
    msg.classList.remove('border-green-300', 'bg-green-50', 'text-green-800');

    if (kind === 'error') msg.classList.add('border-red-300', 'bg-red-50', 'text-red-800');
    else msg.classList.add('border-green-300', 'bg-green-50', 'text-green-800');
  }

  document.getElementById('logoutBtn').addEventListener('click', () => {
    localStorage.clear();
    window.location.href = '/login';
  });

  async function loadCalculations() {
    const tbody = document.getElementById('calculationsTable');

    try {
      const res = await fetch('/calculations', {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (res.status === 401) {
        localStorage.clear();
        window.location.href = '/login';
        return;
      }
      if (!res.ok) throw new Error('Failed to load calculations');

      const calculations = await res.json();
      tbody.innerHTML = '';

      if (!calculations.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" class="px-3 py-4 text-gray-500">No calculations yet.</td>
          </tr>
        `;
        return;
      }

      calculations.forEach(calc => {
        const created = calc.created_at ? new Date(calc.created_at) : null;
        const dateStr = created ? created.toLocaleString() : '';

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-3 py-2 border-b capitalize">${calc.type}</td>
          <td class="px-3 py-2 border-b">${(calc.inputs || []).join(', ')}</td>
          <td class="px-3 py-2 border-b">${calc.result}</td>
          <td class="px-3 py-2 border-b">${dateStr}</td>
          <td class="px-3 py-2 border-b">
            <a class="text-blue-700 hover:underline mr-2" href="/dashboard/view/${calc.id}">View</a>
            <a class="text-gray-700 hover:underline mr-2" href="/dashboard/edit/${calc.id}">Edit</a>
            <button class="text-red-600 hover:underline deleteBtn" data-id="${calc.id}">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      document.querySelectorAll('.deleteBtn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.dataset.id;
          if (!confirm('Delete this calculation?')) return;

          try {
            const delRes = await fetch(`/calculations/${id}`, {
              method: 'DELETE',
              headers: { 'Authorization': `Bearer ${token}` }
            });

            if (delRes.status === 401) {
              localStorage.clear();
              window.location.href = '/login';
              return;
            }
            if (!delRes.ok) throw new Error('Failed to delete calculation');

            showMsg('Deleted.', 'success');
            loadCalculations();
          } catch (e) {
            showMsg(e.message || 'Error deleting calculation', 'error');
          }
        });
      });

    } catch (e) {
      tbody.innerHTML = `
        <tr>
          <td colspan="5" class="px-3 py-4 text-red-700">Error loading calculations.</td>
        </tr>
      `;
    }
  }

  document.getElementById('calculationForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const inputsRaw = document.getElementById('calcInputs').value || '';
    const inputs = inputsRaw.split(',')
      .map(x => parseFloat(x.trim()))
      .filter(x => !Number.isNaN(x));

    if (inputs.length < 2) {
      showMsg('Enter at least two valid numbers separated by commas.', 'error');
      return;
    }

    const payload = { type: document.getElementById('calcType').value, inputs };

    try {
      const res = await fetch('/calculations', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(payload)
      });

      if (res.status === 401) {
        localStorage.clear();
        window.location.href = '/login';
        return;
      }
      if (!res.ok) {
        const data = await res.json().catch(() => ({}));
        throw new Error(data.detail || 'Failed to create calculation');
      }

      showMsg('Calculation saved.', 'success');
      document.getElementById('calculationForm').reset();
      loadCalculations();
    } catch (e) {
      showMsg(e.message || 'Error creating calculation', 'error');
    }
  });

  loadCalculations();
});
</script>
{% endblock %}
